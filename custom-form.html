<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Help chat</title>
	<link rel="stylesheet" href="styles/chat-form.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>
	<div class="chat-form-wrap">
		<div class="chat-form__title">Hi! How can i help you?</div>
		<form id="chat-form">
			<div class="chat-point"></div>
			<div class="chat-window">
				<div class="user-question">Привет</div>
				<div class="bot-answer">Привет! Я Бот</div>
			</div>
			<div class="form-group js--form-group">
				<input type="text" class="question-field" name="question" id="question" required placeholder="Question">
				<div class="request-send js--request-send">
					<img src="imgs/Invitations.svg" class="request-send-btn">
				</div>
				<div class="request-send-loader js--request-send-loader">
					<img src="imgs/Double%20Ring-1s-200px.gif">
				</div>
			</div>

			<div class="chat-form__btn-group">
				<a href="#" class="btn chat-form__btn-success">Success</a>
				<a href="#" class="btn chat-form__btn-fail">Contact Support</a>
			</div>
		</form>
	</div>

	<script type="text/javascript">
		$(document).ready(function () {
			var url = 'https://ac6da8fe.ngrok.io',
				form = $('#chat-form'),
				btnSend = $('.js--request-send'),
				chat = $('.chat-window');

			btnSend.unbind('click').on('click', function (e) {

				//забираем значение инпута и кидаем ajax
				var question = $('input[name="question"]').val();

				//пихаем вопрос пользователя в чат
				chat.append('<div class="user-question">' + question + '</div>');
				scrollingChat(chat);

				if(question) {
					//обнуляем поле ввода и блокируем возможность отправки до ответа бота
					blockRequestField(form);

					$.ajax({
						url : url + '/?question=' + question,
						type : "GET",
						dataType : "jsonp",
						crossDomain: true,
						jsonpCallback: 'json_callback',
						data: {
							question: question
						},
						success: function(json_callback){
							responseAction(json_callback);

						},
						error: function (jxhr, status, err) {
							console.log(err);
							failResponseAction(err);

						}
					});
				}

				e.preventDefault();
			});

			function blockRequestField(form) {
				//очищаем поле ввода
				form.find('input[name="question"]').val('');
				//блокируем поле ввода и отправки сообщения
				form.find('.js--form-group').addClass('disabled');
			}

			function unBlockRequestField(form) {
				form.find('.js--form-group').removeClass('disabled');
			}

			//ответ без ошибок
			function responseAction(json_callback) {
				console.log(json_callback);
				//собираем ответ бота
				if(json_callback.support){
					chat.append('<div class="bot-answer">Я не знаю - спроси у <a href="#" class="bot-answer-support-btn">Support</a></div>');
				} else {
					chat.append('<div class="bot-answer">' + json_callback.response + '</div>');
				}

				//скролим окно чтобы было видно последний блок
				scrollingChat(chat);

				unBlockRequestField(form);
			}

			//ответ - ошибка
			function failResponseAction(err) {
				if(err) {
					chat.append('<div class="bot-answer error">Нет смысла в том, в чем нет смысла :P</div>');
				}

				scrollingChat(chat);

				unBlockRequestField(form);
			}

			function scrollingChat(chat) {
				//высота последнего добавленного блока
				var h_block = parseInt(chat.find('div').last().height()) + 10;

				chat.animate({
					scrollTop: h_block
				}, 300);
			}
		});
	</script>
</body>
</html>